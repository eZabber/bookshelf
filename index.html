<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Library</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f8f7f4; --card: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); max-width: 600px; margin: 0 auto; padding: 20px; color: #333; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        
        /* Google Button */
        #auth-container { text-align: right; }
        #auth-btn { background: #4285F4; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-weight: 500; font-size: 0.85rem; cursor: pointer; }
        #sync-status { font-size: 0.75rem; color: #666; margin-top: 4px; }

        /* Tabs */
        .tabs { display: flex; background: #e0e0e0; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.9rem; color: #666; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Controls */
        .controls { display: flex; gap: 8px; margin-bottom: 20px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; } /* 16px prevents zoom on iOS */
        button.action-btn { padding: 10px 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; }
        button.scan-btn { background: var(--accent); }

        /* Scanner */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 15px; display: none; }

        /* List */
        ul { list-style: none; padding: 0; }
        .book-card { background: var(--card); padding: 12px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; gap: 12px; align-items: start; }
        .book-thumb { width: 60px; height: 90px; background: #eee; border-radius: 4px; object-fit: cover; flex-shrink: 0; }
        .book-info { flex: 1; min-width: 0; }
        .book-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; line-height: 1.3; }
        .book-author { color: #666; font-size: 0.85rem; margin-bottom: 8px; }
        .delete-btn { background: none; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        
        /* Rating */
        select.rating { display: block; margin-bottom: 8px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; background: white; }
    </style>
</head>
<body>

    <header>
        <h1>üìö My Shelf</h1>
        <div id="auth-container">
            <button id="auth-btn" onclick="handleAuthClick()">Sign In</button>
            <div id="sync-status">Local Mode</div>
        </div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchShelf('read', this)">Read</div>
        <div class="tab" onclick="switchShelf('wishlist', this)">Wishlist</div>
    </div>

    <div class="controls">
        <input type="text" id="isbn-input" placeholder="ISBN or Title">
        <button class="action-btn" onclick="handleManualAdd()">Add</button>
        <button class="action-btn scan-btn" onclick="toggleScanner()">üì∑</button>
    </div>

    <div id="reader"></div>
    <ul id="book-list"></ul>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script>
    // --- ‚ö†Ô∏è CONFIGURATION: PASTE YOUR ID HERE ‚ö†Ô∏è ---
    const CLIENT_ID = '579369345257-sqq02cnitlhcf54o5ptad36fm19jcha7.apps.googleusercontent.com'; 
    
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

    // --- STATE ---
    let tokenClient;
    let gapiInited = false, gisInited = false;
    let spreadsheetId = localStorage.getItem('sheetId');
    let currentShelf = 'read';
    let library = JSON.parse(localStorage.getItem('myLibrary')) || { read: [], wishlist: [] };

    // --- INIT ---
    renderBooks();

    // --- GOOGLE AUTH ---
    function gapiLoaded() {
        gapi.load('client', async () => {
            await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            maybeEnableAuth();
        });
    }
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: async (resp) => {
                if (resp.error) return console.error(resp);
                document.getElementById('auth-btn').innerText = "Syncing...";
                await ensureSpreadsheetExists();
                await syncToSheet();
                document.getElementById('auth-btn').innerText = "Synced ‚úÖ";
                document.getElementById('sync-status').innerText = "Connected to Google";
            },
        });
        gisInited = true;
        maybeEnableAuth();
    }
    function maybeEnableAuth() {
        if (gapiInited && gisInited) document.getElementById('auth-btn').disabled = false;
    }
    function handleAuthClick() {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    // --- SYNC LOGIC ---
    async function ensureSpreadsheetExists() {
        if (spreadsheetId) return;
        try {
            const resp = await gapi.client.sheets.spreadsheets.create({ properties: { title: "My Book App Data" } });
            spreadsheetId = resp.result.spreadsheetId;
            localStorage.setItem('sheetId', spreadsheetId);
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: spreadsheetId, range: "Sheet1!A1:E1", valueInputOption: "RAW",
                resource: { values: [["ID", "Title", "Author", "Shelf", "Rating"]] }
            });
        } catch(e) { console.error("Create failed", e); }
    }

    async function syncToSheet() {
        if (!spreadsheetId) return;
        let rows = [];
        ['read', 'wishlist'].forEach(shelf => {
            library[shelf].forEach(b => rows.push([b.id, b.title, b.authors[0].name, shelf, b.rating || 0]));
        });
        try {
            // Clear old data first (simple approach)
            await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId, range: "Sheet1!A2:E999" });
            // Write new
            if(rows.length > 0) {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId, range: "Sheet1!A2", valueInputOption: "RAW", resource: { values: rows }
                });
            }
        } catch(e) { console.error("Sync failed", e); }
    }

    // --- APP LOGIC ---
    function switchShelf(shelf, el) {
        currentShelf = shelf;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        renderBooks();
    }

    async function handleManualAdd() {
        const val = document.getElementById('isbn-input').value.trim();
        if (!val) return;
        // Check if ISBN (numbers/dashes) or just title text
        if (/^[\d-]+$/.test(val) && val.length > 9) {
            await fetchAndAddBook(val);
        } else {
            addBook({ title: val, authors: [{name: "Manual"}], cover: null, id: Date.now() });
        }
        document.getElementById('isbn-input').value = '';
    }

    async function fetchAndAddBook(isbn) {
        const clean = isbn.replace(/-/g, "");
        try {
            const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${clean}&jscmd=data&format=json`);
            const data = await res.json();
            const key = `ISBN:${clean}`;
            if (!data[key]) return alert("Book not found!");
            
            const b = data[key];
            addBook({
                title: b.title,
                authors: b.authors || [{name: "Unknown"}],
                cover: b.cover ? b.cover.medium : null,
                id: Date.now(),
                rating: 0
            });
        } catch(e) { alert("Error fetching book."); }
    }

    function addBook(book) {
        library[currentShelf].push(book);
        saveAndRender();
        alert("Added!");
    }

    function deleteBook(id) {
        if(!confirm("Delete?")) return;
        library[currentShelf] = library[currentShelf].filter(b => b.id !== id);
        saveAndRender();
    }

    function updateRating(id, rating) {
        const book = library['read'].find(b => b.id === id);
        if(book) { book.rating = rating; saveAndRender(); }
    }

    function saveAndRender() {
        localStorage.setItem('myLibrary', JSON.stringify(library));
        renderBooks();
        if (gapi.client.getToken()) syncToSheet(); // Auto-sync if logged in
    }

    function renderBooks() {
        const list = document.getElementById('book-list');
        list.innerHTML = '';
        library[currentShelf].slice().reverse().forEach(b => {
            const li = document.createElement('li');
            li.className = 'book-card';
            
            let ratingHtml = '';
            if(currentShelf === 'read') {
                ratingHtml = `
                <select class="rating" onchange="updateRating(${b.id}, this.value)">
                    <option value="0">Rate...</option>
                    <option value="1" ${b.rating==1?'selected':''}>‚≠ê</option>
                    <option value="2" ${b.rating==2?'selected':''}>‚≠ê‚≠ê</option>
                    <option value="3" ${b.rating==3?'selected':''}>‚≠ê‚≠ê‚≠ê</option>
                    <option value="4" ${b.rating==4?'selected':''}>‚≠ê‚≠ê‚≠ê‚≠ê</option>
                    <option value="5" ${b.rating==5?'selected':''}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                </select>`;
            }

            li.innerHTML = `
                ${b.cover ? `<img src="${b.cover}" class="book-thumb">` : '<div class="book-thumb" style="background:#ddd"></div>'}
                <div class="book-info">
                    <div class="book-title">${b.title}</div>
                    <div class="book-author">${b.authors[0].name}</div>
                    ${ratingHtml}
                    <button class="delete-btn" onclick="deleteBook(${b.id})">Remove</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    // --- SCANNER ---
    let scanner;
    function toggleScanner() {
        const div = document.getElementById('reader');
        if (div.style.display === 'block') { scanner.clear(); div.style.display = 'none'; return; }
        div.style.display = 'block';
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render((txt) => { 
            scanner.clear(); 
            div.style.display='none'; 
            fetchAndAddBook(txt); 
        });
    }
</script>
</body>
</html>
